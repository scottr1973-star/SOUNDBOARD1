<!--
PATH: /index.html
FILE: index.html
PURPOSE: Medical Sound Pad UI — per-group boards, per-group Kit Editor, per-pad sampling & mic record, sentence builder (single track) with scenes & story chain, save/load kits. Includes draggable large-button QWERTY keyboard. Shift key narrowed so Backspace fits on the row.
Created by Scott Russo.
-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Medical Sound Pad</title>
<style>
  :root{ --bg:#0b0f12; --panel:#0f161a; --ink:#e9f6f2; --muted:#a8bdb5; --line:rgba(255,255,255,.14); }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:14px/1.35 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1400px;margin:0 auto;padding:12px}
  .row{display:flex;align-items:center;gap:8px;margin:8px 0}
  .spacer{flex:1}
  .label{font-weight:900;letter-spacing:.3px}
  .card{background:linear-gradient(180deg,#121a1f,#0e1418);border:1px solid var(--line);border-radius:16px;padding:12px}
  .btn{border:1px solid var(--line);background:#141c1f;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.small{padding:6px 10px;font-size:12px}
  .btn[aria-pressed="true"]{outline:2px solid rgba(66,198,255,.5)}
  .pill{font:11px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:#c9ded6}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .num{width:80px;padding:6px 8px;border-radius:8px;border:1px solid var(--line);background:#0f1519;color:#e9f6f2}

  input[type="text"], input[type="number"], select, input[type="color"]{
    padding:6px 8px;border-radius:8px;border:1px solid var(--line);background:#0f1519;color:#e9f6f2
  }
  input::file-selector-button{display:none}
  .visually-hidden{position:absolute !important;width:1px;height:1px;padding:0;margin:-1px;border:0;clip:rect(0 0 0 0);overflow:hidden}

  #boards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:8px}
  .board{--ac:#42c6ff; --ac-rgb:66,198,255; border:1px solid rgba(var(--ac-rgb),.55);border-radius:14px;padding:10px;background:linear-gradient(180deg,#11181d,#0d1418); position:relative; box-shadow:0 0 22px rgba(var(--ac-rgb),.15) inset}
  .board .title{display:flex;align-items:center;gap:10px;font-weight:900}
  .board .dot{width:10px;height:10px;border-radius:50%;background:var(--ac);box-shadow:0 0 12px rgba(var(--ac-rgb),.6);border:1px solid rgba(255,255,255,.22)}
  .board .sub{font:11px;color:#a8bbb4;margin-left:auto}
  .board .hdr-btns{display:flex;gap:8px;margin-left:6px}
  .board .colorpick{appearance:none;border:1px solid var(--line);border-radius:6px;width:26px;height:22px;background:#0f1519;cursor:pointer}

  .padgrid{display:grid;gap:10px;margin-top:8px;width:100%}
  .pad{
    user-select:none;touch-action:manipulation;cursor:pointer;height:78px;border-radius:16px;position:relative;overflow:hidden;
    display:flex;align-items:center;justify-content:center;text-align:center;font-weight:900;letter-spacing:.4px;
    border:1px solid rgba(var(--ac-rgb),.55);
    background:
      radial-gradient(80% 80% at 50% 0%, rgba(var(--ac-rgb),.28), transparent 65%),
      linear-gradient(180deg, #1c2830, #12191e);
    box-shadow:
      0 18px 28px rgba(0,0,0,.45),
      0 0 16px rgba(var(--ac-rgb),.25) inset,
      0 2px 0 rgba(255,255,255,.08) inset,
      0 -14px 26px rgba(0,0,0,.34) inset;
    padding:6px; outline:none;
    filter:saturate(1.35) brightness(1.1);
    font-size:16px; line-height:1.1;
  }
  .pad img{max-width:100%;max-height:100%;object-fit:contain;display:block;pointer-events:none}
  .pad::before{content:""; position:absolute; inset:0; border-radius:16px; pointer-events:none; background:linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,0) 40%); mix-blend-mode:screen; opacity:.85;}
  .pad .badge{position:absolute;bottom:6px;left:8px;font:11px/1.1 ui-monospace,Menlo,Consolas;color:#c0d5cd;opacity:.95}
  .pad.playing{transform:translateY(1px); box-shadow:0 12px 22px rgba(0,0,0,.5), 0 0 24px rgba(var(--ac-rgb), .55), 0 -32px 62px rgba(255,255,255,.12) inset; filter:saturate(1.7) brightness(1.25); outline:2px solid rgba(var(--ac-rgb), .75);}
  .pad.recording{outline:2px solid rgba(255,85,85,.9); box-shadow:0 0 24px rgba(255,85,85,.55), inset 0 -32px 62px rgba(255,255,255,.12);}

  .panel{margin-top:12px;display:none}
  .panel.show{display:block}

  .kit-grid{display:grid;grid-template-columns:260px 1fr;gap:10px;margin-top:8px}
  .kit-head{font-size:12px;color:#c9ded6;opacity:.9;padding:6px 0;border-bottom:1px solid var(--line)}
  #kitRows{display:grid;grid-auto-rows:minmax(56px,auto);gap:8px;margin-top:6px}
  .kit-row{display:grid;grid-template-columns:260px 1fr;gap:12px;align-items:center;padding:10px;border:1px solid var(--line);border-radius:12px;background:#0f1519}
  .kit-row .namecell{display:flex;flex-direction:column;gap:6px}
  .kit-row .padid{font:11px/1.2 ui-monospace,Menlo,Consolas;color:#a8bbb4;opacity:.9}
  .fileline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .kit-controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .kit-controls label{display:flex;gap:6px;align-items:center}
  .kit-controls select{min-width:160px}

  #sentenceBar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  #sentenceList{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{display:flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0f1519}
  .chip .dot{width:8px;height:8px;border-radius:50%}
  .chip .x{border:none;background:transparent;color:#cbdad3;cursor:pointer;font-size:14px;line-height:1}
  .transcript{margin-top:6px;padding:8px 10px;border:1px dashed var(--line);border-radius:10px;background:#0b1215;color:#cfe0d8;font-size:13px}

  @media (max-width: 980px){
    .kit-grid{grid-template-columns:1fr}
    .kit-row{grid-template-columns:1fr}
  }
  @media (max-width:520px){ #boards{grid-template-columns:1fr} }

  /* Bigger primary controls */
  #composeBtn,#sentencePlayBtn,#sentenceStopBtn,#sentenceBackBtn,#sentenceClearBtn,#songModeBtn,#chainEditBtn,#chainClearBtn{
    padding:14px 18px;font-size:16px;border-radius:12px;
  }
  .scene-bar .btn{padding:12px 16px;font-size:16px;border-radius:12px}
  #wpmNum.num,#gapMsNum.num{width:120px;padding:10px 12px;font-size:16px;border-radius:12px}

  /* Header buttons bigger */
  #stopAllBtn,#groupsBtn,#toggleSeqBtn,#toggleKitMgrBtn,#toggleKbBtn{
    padding:14px 18px;font-size:16px;border-radius:12px;min-height:44px;min-width:44px;
  }

  /* Keyboard (draggable) */
  #kbPanel{position:fixed;left:12px;bottom:12px;width:min(1120px,98vw);background:linear-gradient(180deg,#121a1f,#0e1418);border:1px solid var(--line);border-radius:16px;padding:10px;box-shadow:0 22px 44px rgba(0,0,0,.5);display:none;z-index:50}
  #kbPanel.show{display:block}
  #kbBar{display:flex;align-items:center;gap:8px;margin-bottom:8px;cursor:move}
  #kbTitle{font-weight:900}
  #kbInput{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#0f1519;color:#e9f6f2;font-size:20px}
  .kb-rows{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .kb-row{display:flex;gap:10px;flex-wrap:nowrap}
  .key{
    flex:0 0 auto;
    min-width:96px;
    min-height:96px;
    padding:14px 16px;
    border-radius:16px;
    border:1px solid var(--line);
    background:#141c1f;
    color:#e9f6f2;
    font-weight:800;
    font-size:28px;
    letter-spacing:.5px;
    cursor:pointer;
  }
  .key.wide{min-width:140px}             /* SHIFT narrowed */
  .key.backspace{min-width:120px}        /* Backspace stays narrower */
  .key.space{flex:1;min-height:96px}
  .kb-actions{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
  .kb-pill{font:12px;padding:4px 12px;border:1px solid var(--line);border-radius:999px;color:#c9ded6}
  .kb-right{margin-left:auto;display:flex;gap:8px}
  .kb-small{font-size:12px}

  @media (max-width:1100px){
    .kb-row{flex-wrap:wrap}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div class="label">Medical Sound Pad</div>
        <span class="spacer"></span>
        <button class="btn small" id="stopAllBtn">Stop All</button>
        <button class="btn small" id="groupsBtn">Groups</button>
        <button class="btn small" id="toggleSeqBtn">Sentence Builder</button>
        <button class="btn small" id="toggleKitMgrBtn">Kits</button>
        <button class="btn small" id="toggleKbBtn">Keyboard</button>
        <span class="pill" id="status">loading…</span>
      </div>

      <div id="boards"></div>

      <div id="groupsPanel" class="panel">
        <div class="row" style="gap:12px;flex-wrap:wrap">
          <div class="label">Groups</div>
          <span class="spacer"></span>
          <input id="newGroupName" placeholder="Group name (e.g., Nouns)" style="width:220px">
          <label class="small">Rows <input id="newRows" type="number" min="1" max="12" value="4" class="num"></label>
          <label class="small">Cols <input id="newCols" type="number" min="1" max="12" value="4" class="num"></label>
          <label class="small">Color <input id="newColor" type="color" value="#42c6ff" style="height:28px;border:1px solid var(--line);border-radius:6px;background:#0f1519"></label>
          <button class="btn small" id="addGroupBtn">Add Group</button>
          <span class="small muted">Presets:</span>
          <button class="btn small" data-preset="3x3">3×3</button>
          <button class="btn small" data-preset="4x4">4×4</button>
          <button class="btn small" data-preset="5x5">5×5</button>
          <button class="btn small" data-preset="10x10">10×10</button>
        </div>
        <div id="groupList" class="small" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:10px;margin-top:6px"></div>
      </div>

      <div id="kitEditor" class="panel">
        <div class="row" style="flex-wrap:wrap;gap:10px">
          <div class="label">Kit Editor</div>
          <div id="kitGroupBadge" class="row small" style="gap:8px">
            <span id="kitGroupDot" class="dot" style="width:10px;height:10px;border-radius:50%"></span>
            <span id="kitGroupName" class="small muted">—</span>
          </div>
          <span class="spacer"></span>
          <button class="btn small" id="closeKitBtn">Close Editor</button>
          <button class="btn small" id="saveKitBtn">Export .json</button>
          <button class="btn small" id="loadKitBtn">Import .json</button>
          <input type="file" id="loadKitFile" accept=".json" hidden>
        </div>
        <div class="kit-grid">
          <div class="kit-head">Name / Sample / Image</div>
          <div class="kit-head">Mode & Basic Controls</div>
        </div>
        <div id="kitRows"></div>
      </div>

      <div id="seqPanel" class="panel">
        <div id="sentenceBar" class="row" style="flex-wrap:wrap">
          <button class="btn small" id="composeBtn" aria-pressed="false">Compose: Off</button>
          <button class="btn small" id="sentencePlayBtn" aria-pressed="false">Play</button>
          <button class="btn small" id="sentenceStopBtn">Stop</button>
          <button class="btn small" id="sentenceBackBtn">Backspace</button>
          <button class="btn small" id="sentenceClearBtn">Clear</button>
          <label class="small">WPM <input id="wpmNum" class="num" type="number" min="20" max="300" step="1" value="120"></label>
          <label class="small">Gap (ms) <input id="gapMsNum" class="num" type="number" min="0" max="2000" step="10" value="250"></label>
          <label class="small"><input id="ttsFallbackChk" type="checkbox" checked> TTS if empty</label>
          <span class="spacer"></span>
          <span class="pill" id="seqStatus">ready</span>
        </div>
        <div id="sentenceList"></div>
        <div id="transcript" class="transcript small">—</div>

        <div class="row scene-bar" style="margin-top:10px">
          <div class="muted">Scenes:</div>
          <button class="btn small" data-scene="1">A1</button>
          <button class="btn small" data-scene="2">A2</button>
          <button class="btn small" data-scene="3">A3</button>
          <button class="btn small" data-scene="4">A4</button>
          <button class="btn small" data-scene="5">B1</button>
          <button class="btn small" data-scene="6">B2</button>
          <button class="btn small" data-scene="7">B3</button>
          <button class="btn small" data-scene="8">B4</button>
          <span class="spacer"></span>
          <button class="btn small" id="songModeBtn" aria-pressed="false">Story Mode</button>
          <button class="btn small" id="chainEditBtn" aria-pressed="false">Chain Edit</button>
          <button class="btn small" id="chainClearBtn">Clear Chain</button>
        </div>
        <div class="small"><span class="muted">Chain:</span> <span id="chainView" class="muted">—</span></div>
      </div>

      <div id="kitMgrPanel" class="panel">
        <div class="row">
          <div class="label">Kits</div>
          <span class="spacer"></span>
          <input id="kitName" placeholder="Kit name" class="small" style="padding:6px 8px;border:1px solid var(--line);background:#0f1519;color:#e9f6f2;width:220px">
          <button class="btn small" id="kitSaveAs">Save As</button>
          <button class="btn small" id="kitExport">Export</button>
          <button class="btn small" id="kitImportBtn">Import</button>
          <input type="file" id="kitImportFile" accept=".json" hidden>
        </div>
        <div class="small muted" style="margin:4px 0 10px">Local library saves groups, colors, pads, sentences, scenes & chain.</div>
        <div id="kitList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px"></div>
      </div>
    </div>
  </div>

  <!-- Floating Large-Button Keyboard -->
  <div id="kbPanel" role="dialog" aria-label="Keyboard">
    <div id="kbBar">
      <div id="kbTitle">Keyboard</div>
      <span class="kb-pill" id="kbLinkPill" aria-pressed="true">Link to Sentence</span>
      <span class="spacer"></span>
      <button class="btn small" id="kbMinBtn" title="Minimize">—</button>
      <button class="btn small" id="kbCloseBtn" title="Close">✕</button>
    </div>
    <input id="kbInput" type="text" placeholder="Type here…">
    <div class="kb-rows" id="kbRows"></div>
    <div class="kb-actions">
      <button class="btn" id="kbAddSentence">Add to Sentence</button>
      <button class="btn" id="kbAddVocab">Add to Vocabulary</button>
      <span class="kb-small muted">Saved as local vocabulary; caregivers can map words to pads later.</span>
      <span class="kb-right">
        <button class="btn small" id="kbClear">Clear</button>
      </span>
    </div>
  </div>

  <script src="js/soundboard.js" defer
    onerror="(function(){var s=document.createElement('script');s.src='./soundboard.js';s.defer=true;document.body.appendChild(s);})();"></script>

  <script>
  (function(){
    const $ = sel => document.querySelector(sel);

    const kbPanel = $('#kbPanel');
    const kbRows  = $('#kbRows');
    const kbInput = $('#kbInput');
    const kbLinkPill = $('#kbLinkPill');
    const toggleKbBtn = $('#toggleKbBtn');

    window.MedPadAPI = window.MedPadAPI || {};
    window.MedPadAPI.addWordToken = function(text){
      const t = (text||'').trim();
      if(!t) return;

      if (typeof window.sentenceAddToken === 'function'){
        window.sentenceAddToken({text:t, tts:true, from:'keyboard'});
        return;
      }
      if (window.MED_SENTENCE && typeof window.MED_SENTENCE.addToken === 'function'){
        window.MED_SENTENCE.addToken({text:t, tts:true, from:'keyboard'});
        return;
      }

      window.sentenceTokens = window.sentenceTokens || [];
      const token = { id:'k'+Date.now(), text:t, tts:true, from:'keyboard' };
      window.sentenceTokens.push(token);

      const list = $('#sentenceList');
      if (list){
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.dataset.id = token.id;
        chip.innerHTML = '<span class="dot" style="background:#5DD7D0"></span><span>'+escapeHtml(t)+'</span><button class="x" aria-label="remove">×</button>';
        chip.querySelector('.x').onclick = ()=>{
          chip.remove();
          window.sentenceTokens = (window.sentenceTokens||[]).filter(x=>x.id!==token.id);
          updateTranscript();
        };
        list.appendChild(chip);
        updateTranscript();
      }

      function updateTranscript(){
        const tr = $('#transcript');
        if(tr && window.sentenceTokens){
          tr.textContent = window.sentenceTokens.map(x=>x.text).join(' ');
        }
      }
      function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
    };

    const VOCAB_KEY = 'medpad_vocabulary';
    function loadVocab(){ try{ return JSON.parse(localStorage.getItem(VOCAB_KEY))||[] }catch(e){ return [] } }
    function saveVocab(list){ localStorage.setItem(VOCAB_KEY, JSON.stringify(list.slice(0,5000))) }

    const ROWS = [
      "Q W E R T Y U I O P",
      "A S D F G H J K L",
      "SHIFT Z X C V B N M ⌫",
      "SPACE"
    ];
    let shift = false;
    function build(){
      kbRows.innerHTML = '';
      ROWS.forEach((row)=>{
        const div = document.createElement('div');
        div.className = 'kb-row';
        row.split(' ').forEach(k=>{
          const btn = document.createElement('button');
          btn.className = 'key';
          if(k==='SPACE'){ btn.classList.add('space'); btn.textContent = 'Space'; }
          else if(k==='⌫'){ btn.classList.add('backspace'); btn.textContent = 'Backspace'; }
          else if(k==='SHIFT'){ btn.classList.add('wide'); btn.textContent = shift ? 'Shift ↑' : 'Shift'; }
          else { btn.textContent = shift ? k : k.toLowerCase(); }
          btn.addEventListener('click',()=> press(k));
          div.appendChild(btn);
        });
        kbRows.appendChild(div);
      });
    }
    function press(k){
      if(k==='SPACE'){ kbInput.value += ' '; maybeLink(); return; }
      if(k==='⌫'){ kbInput.value = kbInput.value.slice(0,-1); return; }
      if(k==='SHIFT'){ shift = !shift; build(); return; }
      kbInput.value += (shift ? k : k.toLowerCase());
      maybeLink();
    }
    function maybeLink(){
      if(kbLinkPill.getAttribute('aria-pressed')==='true'){
        const parts = kbInput.value.trim().split(/\s+/);
        if (kbInput.value.endsWith(' ') && parts.length){
          const word = parts[parts.length-1];
          if(word) window.MedPadAPI.addWordToken(word);
        }
      }
    }
    build();

    document.getElementById('kbAddSentence').addEventListener('click',()=>{
      const t = kbInput.value.trim();
      if(!t) return;
      window.MedPadAPI.addWordToken(t);
      kbInput.value = '';
    });
    document.getElementById('kbAddVocab').addEventListener('click',()=>{
      const t = kbInput.value.trim();
      if(!t) return;
      const list = loadVocab();
      if(!list.includes(t)) list.unshift(t);
      saveVocab(list);
      flash('#kbAddVocab','Added');
    });
    document.getElementById('kbClear').addEventListener('click',()=> kbInput.value='');

    kbLinkPill.addEventListener('click',()=>{
      const on = kbLinkPill.getAttribute('aria-pressed')!=='true';
      kbLinkPill.setAttribute('aria-pressed', on ? 'true':'false');
      kbLinkPill.style.outline = on ? '2px solid rgba(66,198,255,.5)' : 'none';
    });

    toggleKbBtn.addEventListener('click',()=> kbPanel.classList.toggle('show'));
    document.getElementById('kbCloseBtn').addEventListener('click',()=> kbPanel.classList.remove('show'));
    document.getElementById('kbMinBtn').addEventListener('click',()=>{
      if(kbRows.style.display!=='none'){ kbRows.style.display='none'; } else { kbRows.style.display=''; }
    });

    (function makeDraggable(box, handle){
      let sx=0, sy=0, bx=0, by=0, dragging=false;
      const start = (e)=>{
        dragging=true;
        const p = box.getBoundingClientRect();
        bx = p.left; by = p.top;
        sx = ('touches' in e)? e.touches[0].clientX : e.clientX;
        sy = ('touches' in e)? e.touches[0].clientY : e.clientY;
        document.addEventListener('mousemove',move,{passive:false});
        document.addEventListener('mouseup',end);
        document.addEventListener('touchmove',move,{passive:false});
        document.addEventListener('touchend',end);
        e.preventDefault();
      };
      const move = (e)=>{
        if(!dragging) return;
        const x = ('touches' in e)? e.touches[0].clientX : e.clientX;
        const y = ('touches' in e)? e.touches[0].clientY : e.clientY;
        let nx = bx + (x - sx);
        let ny = by + (y - sy);
        const vw = window.innerWidth, vh = window.innerHeight;
        const r = box.getBoundingClientRect();
        nx = Math.max(6, Math.min(vw - r.width - 6, nx));
        ny = Math.max(6, Math.min(vh - r.height - 6, ny));
        box.style.left = nx + 'px';
        box.style.top  = ny + 'px';
        box.style.right = 'auto';
        box.style.bottom= 'auto';
      };
      const end = ()=>{
        dragging=false;
        document.removeEventListener('mousemove',move);
        document.removeEventListener('mouseup',end);
        document.removeEventListener('touchmove',move);
        document.removeEventListener('touchend',end);
      };
      handle.addEventListener('mousedown',start);
      handle.addEventListener('touchstart',start,{passive:false});
    })(kbPanel, document.getElementById('kbBar'));

    function flash(sel, text){
      const b = document.querySelector(sel);
      const prev = b.textContent;
      b.textContent = text;
      setTimeout(()=>{ b.textContent = prev; }, 700);
    }

    window.addEventListener('DOMContentLoaded',function(){
      setTimeout(function(){
        if(!window.__MEDPAD_READY){
          var st=document.getElementById('status');
          if(st) st.textContent='script not found — tried fallback';
        }
      },400);
    });
  })();
  </script>
</body>
</html>
